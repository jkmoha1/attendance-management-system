package com.parabank.utils;

import com.parabank.managers.DriverManager;
import org.openqa.selenium.OutputType;
import org.openqa.selenium.TakesScreenshot;
import org.openqa.selenium.WebDriver;

import java.io.File;
import java.nio.file.Files;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

public class ScreenshotUtil {

    private static ScreenshotUtil INSTANCE;
    private String screenshotsDir = "test-output/screenshots";

    private ScreenshotUtil() {}

    public static synchronized ScreenshotUtil getInstance() {
        if (INSTANCE == null) {
            INSTANCE = new ScreenshotUtil();
        }
        return INSTANCE;
    }

    public void setScreenshotsDir(String dir) {
        if (dir != null && !dir.isBlank()) {
            screenshotsDir = dir;
        }
    }

    public String take(String testName) {
        WebDriver driver = null;
        try {
            driver = DriverManager.getDriver();
        } catch (Exception ignored) {}

        if (driver == null) return null;

        try {
            File src = ((TakesScreenshot) driver).getScreenshotAs(OutputType.FILE);
            String ts = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMdd_HHmmss"));

            File outDir = new File(screenshotsDir);
            if (!outDir.exists()) outDir.mkdirs();

            File dest = new File(outDir, testName + "_" + ts + ".png");
            Files.copy(src.toPath(), dest.toPath());
            return dest.getAbsolutePath();
        } catch (Throwable t) {
            return null;
        }
    }
}
